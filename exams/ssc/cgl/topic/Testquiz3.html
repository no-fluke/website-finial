<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Testquiz3</title>
<style>
:root{
  --accent:#2ec4b6;
  --accent-dark:#1da89a;
  --muted:#69707a;
  --success:#1f9e5a;
  --danger:#c82d3f;
  --warning:#f39c12;
  --info:#3498db;
  --purple:#9b59b6;
  --bg:#f5f7fa;
  --card:#fff;
  --maxw:820px;
  --radius:10px;
  --text:#111;
  --border:#e6eaec;
}

/* Dark mode variables */
body.dark-mode {
  --accent:#3dd4c4;
  --accent-dark:#2bb9a9;
  --muted:#a0a8b2;
  --success:#2ecc71;
  --danger:#e74c3c;
  --warning:#f1c40f;
  --info:#5dade2;
  --purple:#bb8fce;
  --bg:#1a1e24;
  --card:#2c3e50;
  --text:#ecf0f1;
  --border:#4a5a6a;
}

*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;background:var(--bg);color:var(--text);padding-bottom:96px;transition:background-color 0.2s, color 0.2s;}
.container{max-width:var(--maxw);margin:auto;padding:10px 16px}
header{background:var(--card);box-shadow:0 2px 6px rgba(0,0,0,0.08);position:relative;z-index:10}
.header-inner{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;gap:12px}
h1{margin:0;color:var(--accent);font-size:18px}
.btn{background:var(--accent);color:#fff;border:none;border-radius:6px;padding:8px 12px;font-size:13px;font-weight:600;cursor:pointer;transition:background .18s}
.btn:hover{background:var(--accent-dark)}
.btn-ghost{background:transparent;color:var(--accent);border:2px solid var(--accent);padding:8px 12px;border-radius:999px;font-weight:700;cursor:pointer}
.timer-text{color:var(--accent-dark);font-weight:700;font-size:18px;min-width:72px;text-align:right}
.toggle-pill{position:relative;width:90px;height:30px;background:#eaeef0;border-radius:999px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;padding:0 6px;font-size:13px;color:#444;font-weight:600}
.toggle-pill span{z-index:2;flex:1;text-align:center}
.toggle-pill::before{content:"";position:absolute;top:3px;left:3px;width:42px;height:24px;background:var(--accent);border-radius:999px;transition:.28s}
.toggle-pill.active::before{transform:translateX(45px);background:var(--accent-dark)}
.toggle-pill.active span:last-child{color:#fff}
.toggle-pill span:first-child{color:#fff}
.toggle-pill span:last-child{color:#444}
body.dark-mode .toggle-pill span:first-child{color:#444}
body.dark-mode .toggle-pill span:last-child{color:#fff}

/* quiz card */
.card{background:var(--card);border-radius:10px;padding:10px 12px;margin:12px 0;box-shadow:0 4px 10px rgba(0,0,0,0.05)}
.qbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.qmeta{font-size:13px;color:var(--muted)}
.marking{font-size:13px;color:var(--muted)}
.qtext{font-size:16px;margin:6px 0;font-weight:500}
.opt{padding:10px;border:1px solid var(--border);border-radius:8px;background:var(--card);cursor:pointer;display:flex;align-items:center;gap:10px;transition:all .12s;font-weight:500}
.opt:hover{border-color:#cfd8da}
.opt.selected{border-color:var(--accent)}
.opt.correct{border-color:var(--success);background:rgba(31,158,90,0.12)}
.opt.wrong{border-color:var(--danger);background:rgba(200,45,63,0.12)}
.custom-radio{display:none;height:16px;width:16px;border-radius:50%;border:2px solid #ccc}
.opt.selected .custom-radio{display:block;border:6px solid var(--accent)}
.opt.correct .custom-radio{display:block;border:6px solid var(--success)}
.opt.wrong .custom-radio{display:block;border:6px solid var(--danger)}
.explanation{margin-top:8px;padding:10px;border-radius:8px;background:#fbfdfe;border:1px solid #edf2f3;display:none;font-size:14px}
body.dark-mode .explanation{background:#2c3e50;border-color:#4a5a6a;}

/* bottom nav */
.fbar{position:fixed;left:0;right:0;bottom:0;background:var(--card);box-shadow:0 -3px 12px rgba(0,0,0,0.08);display:flex;justify-content:center;z-index:50}
.fbar-inner{display:flex;justify-content:center;align-items:center;gap:10px;max-width:var(--maxw);width:100%;padding:10px}
.fbar button{background:var(--accent);color:#fff;border:none;border-radius:6px;padding:8px 12px;font-size:13px;font-weight:600;cursor:pointer}
.fbar button:hover{background:var(--accent-dark)}

/* palette popup */
#palette{position:fixed;top:64px;right:14px;background:var(--card);border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,0.12);padding:12px;display:none;gap:8px;flex-wrap:wrap;z-index:200;max-width:300px;max-height:70vh;overflow-y:auto;overscroll-behavior:contain}
#palette .qbtn{width:44px;height:44px;border-radius:8px;border:1px solid var(--border);background:var(--card);cursor:pointer;font-weight:700;color:var(--text)}
#palette .qbtn.attempted{background:var(--success);color:#fff;border:none}
#palette .qbtn.unattempted{background:var(--danger);color:#fff;border:none}
#palette .qbtn.marked{background:var(--purple);color:#fff;border:none}
#palette .qbtn.sol-right{background:var(--success);color:#fff;border:none}
#palette .qbtn.sol-wrong{background:var(--danger);color:#fff;border:none}
#palette .qbtn.sol-skip{background:#9e9e9e;color:#fff;border:none}
#palette .qbtn.has-star{position:relative}
#palette .qbtn.has-star::after{content:"‚òÖ";position:absolute;bottom:2px;right:2px;font-size:12px;color:gold;text-shadow:0 0 2px #000}
#palette .qbtn.current{border:3px solid var(--accent);font-weight:bold;transform:scale(1.05);box-shadow:0 0 0 2px rgba(46,196,182,0.2)}
#palette-summary{margin-top:8px;font-size:13px;color:var(--muted);text-align:center}

/* modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:300}
.modal-content{background:var(--card);border-radius:12px;padding:18px;max-width:420px;width:92%;text-align:center;box-shadow:0 8px 24px rgba(0,0,0,0.18)}
.modal h3{margin:0 0 8px;color:var(--accent)}
.modal p{color:var(--text);margin:8px 0 12px;font-size:15px}
.modal .actions{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
.btn-primary{background:linear-gradient(135deg,var(--accent),var(--accent-dark));color:#fff;border:none;padding:8px 14px;border-radius:999px;font-weight:700;cursor:pointer}

/* results */
.results{margin-top:12px}
.stats{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0}
.stat{flex:1 1 120px;padding:10px;border-radius:10px;text-align:center;background:#f7fbfb;border:1px solid #e6eeed}
.stat h4{margin:0;color:var(--accent);font-size:13px}
.stat p{margin:6px 0 0;font-weight:700;font-size:18px}
body.dark-mode .stat{background:#2c3e50;border-color:#4a5a6a;}

/* New buttons */
.btn-mark{background:var(--purple);color:#fff}
.btn-save{background:var(--info);color:#fff}
.btn-clear{background:var(--warning);color:#fff}

/* üîê COPY & SELECTION BLOCK */
body{
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}
input, textarea{
  user-select: text !important;
}

/* üîê WATERMARK (multi‚Äëlayer) */
.watermark-container {
  position: fixed;
  inset: 0;
  z-index: 3;
  pointer-events: none;
  overflow: hidden;
}
.watermark {
  position: absolute;
  font-size: 26px;
  font-weight: 700;
  color: rgba(0,0,0,0.045);
  transform: rotate(-30deg);
  white-space: nowrap;
}
body.dark-mode .watermark {
  color: rgba(255,255,255,0.045);
}

/* üî¢ MathJax mobile safety */
mjx-container{
  max-width: 100%;
  overflow-x: auto;
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, sans-serif !important;
  font-size: 1em;
}

/* Responsive design */
@media (max-width: 768px){
  .header-inner{ flex-direction: column; gap:8px; padding:8px; }
  .fbar-inner{ flex-wrap: wrap; padding:8px; gap:6px; }
  .fbar button{ padding:6px 8px; font-size:12px; flex:1 1 80px; }
  .container{ padding:8px; }
  .qtext{ font-size:15px; }
  .opt{ padding:8px; }
  #palette{ top:120px; left:50%; transform:translateX(-50%); max-width:90%; }
  #palette .qbtn{ width:38px; height:38px; }
  .stats{ flex-direction:column; }
  .stat{ flex:1 1 auto; }
}
@media (max-width: 480px){
  .timer-text{ font-size:16px; }
  h1{ font-size:16px; }
  .btn, .btn-ghost{ padding:6px 10px; font-size:12px; }
  .fbar-inner{ gap:4px; }
  .fbar button{ padding:6px; font-size:11px; }
  .card{ padding:8px; }
}
@media (min-width: 1024px){
  .container{ max-width:900px; }
  .fbar-inner{ max-width:900px; }
}

/* tabs for results */
.tabs {
  display: flex;
  gap: 4px;
  background: var(--card);
  padding: 8px;
  border-radius: 40px;
  margin: 20px 0;
}
.tab {
  flex: 1;
  text-align: center;
  padding: 10px;
  border-radius: 30px;
  background: transparent;
  border: none;
  color: var(--text);
  font-weight: 600;
  cursor: pointer;
}
.tab.active {
  background: var(--accent);
  color: white;
}
.section {
  display: none;
}
.section.active {
  display: block;
}
.filter-buttons {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin: 16px 0;
}
.filter-btn {
  background: transparent;
  border: 1px solid var(--border);
  padding: 6px 16px;
  border-radius: 30px;
  cursor: pointer;
}
.filter-btn.active {
  background: var(--accent);
  color: white;
  border-color: var(--accent);
}
.leaderboard-entry {
  display: flex;
  justify-content: space-between;
  padding: 8px;
  border-bottom: 1px solid #eee;
}
body.dark-mode .leaderboard-entry {
  border-bottom-color: #4a5a6a;
}
</style>

<!-- üî¢ MathJax -->
<script>
  window.MathJax = {
    tex: {
      inlineMath: [['\\(', '\\)'], ['$', '$']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']]
    },
    options: { skipHtmlTags: ['script', 'style', 'textarea', 'pre'] }
  };
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>

<!-- üî• Firebase SDK (App, Auth, Database) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
  // üî• Your Firebase configuration (UPDATED)
  const firebaseConfig = {
    apiKey: "AIzaSyAQk0dJayCyv8gfDGsYW-XSYC5n13oWvpA",
    authDomain: "ssc-journey.firebaseapp.com",
    databaseURL: "https://ssc-journey-default-rtdb.asia-southeast1.firebasedatabase.app/",
    projectId: "ssc-journey",
    storageBucket: "ssc-journey.firebasestorage.app",
    messagingSenderId: "151868913274",
    appId: "1:151868913274:web:d5a49a708b1db722052dc3",
    measurementId: "G-YZRSZ3V8F8"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  // ---------- CONFIGURATION ----------
  const LOGIN_PAGE_URL = "login.html";
  // -----------------------------------

  // Quiz data from Python
  const QUIZ_TITLE = "Testquiz3";
  const QUESTIONS = [ ... ]; // (truncated for brevity, same as original)
  const TOTAL_TIME_SECONDS = 1500;

  // Global state
  let currentUser = null;
  let current = 0;
  let answers = {};
  let markedForReview = new Set();
  let seconds = TOTAL_TIME_SECONDS;
  let timerInterval = null;
  // Always in "Test" mode (showing solutions) ‚Äì the toggle now controls dark/light only
  const isQuiz = false;

  const QUIZ_STATE_KEY = "ssc_quiz_state_" + QUIZ_TITLE;
  const QUIZ_RESULT_KEY = "ssc_quiz_result_" + QUIZ_TITLE;

  const el = id => document.getElementById(id);

  function showQuizImmediately() {
    el('loadingMessage').style.display = 'none';
    el('quizHeader').style.display = 'flex';
    el('quizContainer').style.display = 'block';
    el('floatBar').style.display = 'flex';
    if (!window.quizInitialized) {
      initQuiz();
      window.quizInitialized = true;
    }
  }

  function redirectToLogin() {
    const returnTo = encodeURIComponent(window.location.href);
    window.location.href = LOGIN_PAGE_URL + "?returnTo=" + returnTo;
  }

  // Update user name display
  function updateUserNameDisplay() {
    const userNameSpan = el('userName');
    if (userNameSpan && currentUser) {
      userNameSpan.textContent = currentUser.displayName || currentUser.email || 'Student';
    }
  }

  // ---------- AUTH ----------
  window.addEventListener('DOMContentLoaded', () => {
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(console.error);
    let authResolved = false;
    const authTimeout = setTimeout(() => {
      if (!authResolved) redirectToLogin();
    }, 4000);

    const cachedUid = localStorage.getItem('quiz_user_uid');
    const cachedEmail = localStorage.getItem('quiz_user_email');
    const cachedName = localStorage.getItem('quiz_user_displayName');
    const cachedTime = localStorage.getItem('quiz_login_time');
    const now = Date.now();
    const CACHE_VALIDITY = 60 * 60 * 1000;

    if (cachedUid && cachedTime && (now - cachedTime < CACHE_VALIDITY)) {
      currentUser = { uid: cachedUid, email: cachedEmail, displayName: cachedName || cachedEmail };
      showQuizImmediately();
      updateUserNameDisplay();
    }

    auth.onAuthStateChanged(user => {
      authResolved = true;
      clearTimeout(authTimeout);
      if (user) {
        currentUser = user;
        localStorage.setItem('quiz_user_uid', user.uid);
        localStorage.setItem('quiz_user_email', user.email);
        localStorage.setItem('quiz_user_displayName', user.displayName || '');
        localStorage.setItem('quiz_login_time', Date.now());
        updateUserNameDisplay();
        if (!window.quizInitialized) showQuizImmediately();
      } else {
        localStorage.removeItem('quiz_user_uid');
        localStorage.removeItem('quiz_user_email');
        localStorage.removeItem('quiz_user_displayName');
        localStorage.removeItem('quiz_login_time');
        redirectToLogin();
      }
    }, error => {
      console.error("Auth error:", error);
      authResolved = true;
      clearTimeout(authTimeout);
      el('loadingMessage').innerText = 'Authentication error. Please refresh.';
      setTimeout(redirectToLogin, 2000);
    });
  });

  // ---------- QUIZ FUNCTIONS ----------
  function initQuiz() {
    el("qtotal").textContent = QUESTIONS.length;
    const resultSaved = localStorage.getItem(QUIZ_RESULT_KEY);
    if (resultSaved) {
      const data = JSON.parse(resultSaved);
      if (data.submitted && data.resultHTML) {
        showSavedResult(data);
        return;
      }
    }
    const saved = localStorage.getItem(QUIZ_STATE_KEY);
    if (saved) {
      const state = JSON.parse(saved);
      current = state.current ?? 0;
      answers = state.answers ?? {};
      seconds = state.seconds ?? seconds;
      if (state.markedForReview) markedForReview = new Set(state.markedForReview);
    }
    renderQuestion(current);
    startTimer();
    attachListeners();
    buildPalette();
    highlightPalette();
    renderMath();
  }

  function showSavedResult(data) {
    el("quizCard").style.display = "none";
    el("floatBar").style.display = "none";
    el("results").innerHTML = data.resultHTML;
    el("results").style.display = "block";
    if (data.headerHTML) {
      el("headerControls").innerHTML = data.headerHTML;
      rebindResultHeaderActions();
    }
    renderMath();
  }

  function renderQuestion(i) {
    current = i;
    const q = QUESTIONS[i];
    el("qindex").textContent = i+1;
    el("qtext").innerHTML = q.question || "";
    normalizeMathForQuiz(el("qtext"));
    renderMath();
    el("marking").innerHTML = `Marking: <span style="color:var(--success)">+${Number(q.correct_score ?? 1)}</span> / <span style="color:var(--danger)">-${Number(q.negative_score ?? 0)}</span>`;
    const opts = el("options");
    opts.innerHTML = "";
    const qid = q.id ?? i;
    const userAns = answers[qid];

    ["option_1","option_2","option_3","option_4","option_5"].forEach((k, idx) => {
      if(!q[k]) return;
      const div = document.createElement("div");
      div.className = "opt";
      div.innerHTML = `<div class="custom-radio"></div><div style="flex:1">${q[k]}</div>`;

      // In Test mode (isQuiz = false): show correct answer and user's wrong answer (if any)
      const isCorrect = String(q.answer) === String(idx+1);
      const isUserWrong = (userAns && userAns === String(idx+1) && !isCorrect);
      if (isCorrect) div.classList.add("correct");
      else if (isUserWrong) div.classList.add("wrong");
      // No click handler in solution mode ‚Äì answers cannot be changed after seeing solutions
      opts.appendChild(div);
    });

    // Show explanation
    if (q.solution_text) {
      el("explanation").innerHTML = `<strong>Explanation:</strong> ${q.solution_text}`;
      el("explanation").style.display = "block";
      normalizeMathForQuiz(el("explanation"));
      renderMath();
    } else {
      el("explanation").style.display = "none";
    }

    highlightPalette();
    saveQuizState();
  }

  function startTimer() {
    el("timer").textContent = fmt(seconds);
    timerInterval = setInterval(() => {
      seconds--;
      el("timer").textContent = fmt(seconds);
      if(seconds <= 0) {
        clearInterval(timerInterval);
        document.getElementById("submitBtn")?.click();
      }
    }, 1000);
  }

  function fmt(s) {
    const m = Math.floor(s/60);
    const sec = s%60;
    return `${String(m).padStart(2,"0")}:${String(sec).padStart(2,"0")}`;
  }

  function saveQuizState() {
    const state = {
      current,
      answers,
      seconds,
      markedForReview: Array.from(markedForReview)
    };
    localStorage.setItem(QUIZ_STATE_KEY, JSON.stringify(state));
  }

  function normalizeMathForQuiz(container) {
    if (!container) return;
    container.innerHTML = container.innerHTML
      .replace(/(\S)\s*\$\$(.+?)\$\*\s*(\S)/g, '$1 \\($2\\) $3')
      .replace(/\$\$(.+?)\$\$/g, function(match, math) {
        if (/^<br>|<div>|<\/div>|<p>|<\/p>/.test(match)) return match;
        return '\\(' + math + '\\)';
      });
  }

  function renderMath() {
    if (window.MathJax && MathJax.typesetPromise) MathJax.typesetPromise();
  }

  // ---------- DARK MODE TOGGLE ----------
  function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    const toggle = el('modeToggle');
    toggle.classList.toggle('active', document.body.classList.contains('dark-mode'));
  }

  // ---------- LEADERBOARD (first attempts only) ----------
  function loadLeaderboard() { /* ... same as original ... */ }

  // ---------- ATTEMPT HISTORY ----------
  function loadAttemptHistory() { /* ... same as original ... */ }

  // ---------- SUBMIT QUIZ ----------
  function submitQuiz() {
    clearInterval(timerInterval);
    const timeTaken = TOTAL_TIME_SECONDS - seconds;

    let correct = 0, wrong = 0, totalMarks = 0, maxMarks = 0;
    QUESTIONS.forEach(q => {
      maxMarks += Number(q.correct_score ?? 1);
      const ans = answers[q.id ?? q];
      if (ans && String(ans) === String(q.answer)) {
        correct++;
        totalMarks += Number(q.correct_score ?? 1);
      } else if (ans) {
        wrong++;
        totalMarks -= Number(q.negative_score ?? 0);
      }
    });
    const attempted = Object.keys(answers).length;
    const unattempted = QUESTIONS.length - attempted;
    const accuracy = attempted ? ((correct/attempted)*100).toFixed(1) : "0.0";

    const displayName = currentUser.displayName || currentUser.email || 'Anonymous';

    const payload = {
      userId: currentUser.uid,
      email: currentUser.email,
      displayName: displayName,
      score: totalMarks,
      maxMarks,
      correct,
      wrong,
      unattempted,
      attempted,
      accuracy,
      timeTaken,
      quizId: QUIZ_TITLE,
      submittedAt: Date.now(),
      answers: QUESTIONS.map((q, i) => {
        const qid = q.id ?? i;
        return {
          question: q.question,
          options: [q.option_1, q.option_2, q.option_3, q.option_4, q.option_5].filter(Boolean),
          correctAnswer: String(q.answer),
          userAnswer: answers[qid] || null
        };
      })
    };

    // Save to attempt_history (all attempts)
    db.ref(`attempt_history/${QUIZ_TITLE}/${currentUser.uid}/${payload.submittedAt}`).set(payload);

    // Save to quiz_results only if it's the user's first attempt
    const quizResultsRef = db.ref(`quiz_results/${QUIZ_TITLE}/${currentUser.uid}`);
    quizResultsRef.once("value").then(snap => {
      if (!snap.exists()) {
        quizResultsRef.set(payload);
      }
    });

    displayResults(payload);
  }

  // ---------- DISPLAY RESULTS (4 TABS) ----------
  function displayResults(payload) { /* ... same as original ... */ }

  // ---------- REFRESH RANK ----------
  function refreshRank() { /* ... same as original ... */ }

  function filterResults(type) { /* ... same as original ... */ }

  // ---------- ATTACH LISTENERS ----------
  function attachListeners() {
    el("nextBtn").addEventListener("click", () => current < QUESTIONS.length-1 && renderQuestion(current+1));
    el("prevBtn").addEventListener("click", () => current > 0 && renderQuestion(current-1));
    el("clearBtn").addEventListener("click", () => {
      delete answers[QUESTIONS[current].id ?? current];
      renderQuestion(current);
      highlightPalette();
    });
    el("markReviewBtn").addEventListener("click", () => {
      markedForReview.has(current) ? markedForReview.delete(current) : markedForReview.add(current);
      highlightPalette();
      saveQuizState();
    });
    el("saveNextBtn").addEventListener("click", () => {
      saveQuizState();
      if (current < QUESTIONS.length-1) renderQuestion(current+1);
    });
    el("paletteBtn").addEventListener("click", (e) => {
      e.stopPropagation();
      togglePalette();
    });
    el("submitBtn").addEventListener("click", () => {
      const attempted = Object.keys(answers).length;
      el("submitMsg").textContent = `You attempted ${attempted} of ${QUESTIONS.length}. Submit?`;
      el("submitModal").style.display = "flex";
    });
    el("cancelSubmit").addEventListener("click", () => el("submitModal").style.display = "none");
    el("confirmSubmit").addEventListener("click", () => {
      el("submitModal").style.display = "none";
      submitQuiz();
    });
    // Dark/light toggle
    el("modeToggle").addEventListener("click", toggleDarkMode);
    document.addEventListener("click", (ev) => {
      const pal = el("palette");
      if(pal && pal.style.display === "flex" && !pal.contains(ev.target) && ev.target !== el("paletteBtn") && !el("paletteBtn").contains(ev.target)) {
        pal.style.display = "none";
      }
    });
  }

  // ---------- PALETTE ----------
  function buildPalette() { /* ... same as original, but uses isQuiz = false ... */ }
  function highlightPalette() { /* ... same as original, uses isQuiz = false ... */ }
  function togglePalette() { /* ... same ... */ }
  function reattemptQuiz() { /* ... same ... */ }
  function rebindResultHeaderActions() { }

  // Disable copy protection (optional)
  document.addEventListener("contextmenu", e => e.preventDefault());
  document.addEventListener("keydown", function(e) {
    if ((e.ctrlKey || e.metaKey) && ["c","x","v","a","s","p","u"].includes(e.key.toLowerCase())) e.preventDefault();
  });
</script>
</head>
<body>
<!-- Simple loading indicator -->
<div id="loadingMessage" style="text-align:center; margin-top:50px; font-size:18px;">Checking authentication...</div>

<!-- QUIZ HEADER (hidden initially) -->
<header id="quizHeader" style="display:none;">
  <div class="header-inner" id="headerControls">
    <div style="display:flex; align-items:center; gap:12px">
      <div class="toggle-pill" id="modeToggle"><span>Light</span><span>Dark</span></div>
    </div>
    <div style="display:flex; align-items:center; gap:10px">
      <span id="userName" style="font-weight:600; margin-right:8px; color:var(--accent);"></span>
      <div class="timer-text" id="timer">00:00</div>
      <button id="submitBtn" class="btn">Submit</button>
      <button id="paletteBtn" class="btn-ghost">View</button>
    </div>
  </div>
</header>

<!-- QUIZ CONTAINER (hidden initially) -->
<div id="quizContainer" class="container" style="display:none;">
  <div id="quizCard" class="card">
    <div class="qbar">
      <div class="qmeta">Question <span id="qindex">0</span> / <span id="qtotal">0</span></div>
      <div class="marking" id="marking"></div>
    </div>
    <div class="qtext" id="qtext"></div>
    <div class="options" id="options"></div>
    <div id="explanation" class="explanation"></div>
  </div>
  <div id="results" class="results" style="display:none;"></div>
</div>

<!-- BOTTOM NAVIGATION (hidden initially) -->
<div class="fbar" id="floatBar" style="display:none;">
  <div class="fbar-inner">
    <button id="prevBtn">‚Üê Prev</button>
    <button id="markReviewBtn" class="btn-mark">Mark for Review</button>
    <button id="clearBtn" class="btn-clear">Clear</button>
    <button id="saveNextBtn" class="btn-save">Save & Next</button>
    <button id="nextBtn">Next ‚Üí</button>
  </div>
</div>

<!-- SUBMIT MODAL -->
<div id="submitModal" class="modal">
  <div class="modal-content">
    <h3>Submit quiz?</h3>
    <p id="submitMsg">You attempted X/Y. Are you sure you want to submit?</p>
    <div class="actions">
      <button id="cancelSubmit" class="btn-ghost">Cancel</button>
      <button id="confirmSubmit" class="btn-primary">Submit</button>
    </div>
  </div>
</div>

<!-- PALETTE -->
<div id="palette" aria-hidden="true"></div>

<!-- Multi‚Äëlayer watermark (customizable) -->
<div class="watermark-container">
  <div class="watermark" style="top:10%; left:5%;">@SSC_JOURNEY2</div>
  <div class="watermark" style="top:30%; left:60%;">@SSC_JOURNEY2</div>
  <div class="watermark" style="top:55%; left:25%;">@SSC_JOURNEY2</div>
  <div class="watermark" style="top:75%; left:65%;">@SSC_JOURNEY2</div>
  <div class="watermark" style="top:90%; left:10%;">@SSC_JOURNEY2</div>
</div>

</body>
</html>
